# 概要

[ビッグデータ分析・活用のためのSQLレシピ](www.amazon.co.jp/dp/4839961263) のメモ

## 3. データ加工のための SQL

### 3-1 1つの値に対する操作

`mst_users` テーブルを作成する時に気になった事

- [DATETIMEとTIMESTAMPの違いや2038年問題などについて解説](https://style.potepan.com/articles/18812.html)

#### URL から要素を取り出す

`SUBSTRING_INDEX` を使ってやったけど、めちゃくちゃ手間。分析するなら `PostgreSQL` を聞いたことがあったけど理解した。
MySQL8 系ならまた違うのかもしれないけど、そしたら認証系で面倒だった覚えがある。


#### 欠損値をデフォルト値に置き換える

SQL では、`NULL` と計算すると結果は `NULL` になる。それだと分析時に不都合なので、`COALESCE` を使って **null の時は、この値として計算する**　ということを指定できる。

### 3-2 複数の値に対する操作

整数型の演算は整数になるので、パーセントを求める時など工夫をしないと 0 になる SQL エンジンがある(ex. PostgreSQL)。
`CAST` 関数を使うと良い。

#### 日付の計算

#### IP アドレスを扱う

PostgreSQL は `inet` 型を使えば簡単に大小比較や範囲を扱うことができる。
MySQL は、`inet_aton` を使うと大小比較ができる。`inet_aton` は文字列の IP アドレスを数値に変換して比較する。
範囲を調べる場合は、`inet_aton('127.0.0.1') BETWEEN inet_aton('127.0.0.0') AND inet_aton('127.0.0.255')` みたいにする。

### 3-3 1つのテーブルに対する操作

集約関数をウィンドウ関数として使うには、後ろに　`OVER` 句を指定する。

```
OVER() => テーブル全体に集約関数を適用
OVER(PARTITION BY hogehoge) => hogehoge カラムでグループ化して集約関数を適用
```

複数の行にまたがる値を繋げる時は、`GROUP_CONCAT(product_id SEPARATOR ',') AS product_ids,` のように `GROUP_CONCAT` を使う。

縦持ちのデータを横持ちにするのは、比較的に簡単。横持ちのデータを縦持ちにするのは、面倒。

### 3-4 複数のテーブルに対する操作

`WITH` 句の事を、CTE(Common Table Expression) と呼ぶ。一時的なテーブルを作るために、使う。

## 4. 売上を把握するためのデータ抽出

`OVER` 句やウィンドウ関数を使うのが多かった。実行環境が MySQL 5.7 だったので、サンプルコードを実行できず SKIP